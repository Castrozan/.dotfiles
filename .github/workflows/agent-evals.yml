name: Agent Evals

# Only run when agent-related files change
on:
  push:
    branches: [main]
    paths:
      - 'agents/**'
      - 'home/modules/claude/**'
      - 'tests/agents/**'
      - '.github/workflows/agent-evals.yml'
  pull_request:
    branches: [main]
    paths:
      - 'agents/**'
      - 'home/modules/claude/**'
      - 'tests/agents/**'
      - '.github/workflows/agent-evals.yml'
  workflow_dispatch:  # Manual trigger

concurrency:
  group: agent-evals-${{ github.ref }}
  cancel-in-progress: true

jobs:
  smoke-test:
    name: Smoke Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install anthropic pyyaml

      - name: Run smoke test
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          if [ -z "$ANTHROPIC_API_KEY" ]; then
            echo "::warning::ANTHROPIC_API_KEY not set, running dry-run"
            python tests/agents/run-evals.py --smoke --dry-run
          else
            python tests/agents/run-evals.py --smoke
          fi

  # Full evals only on main branch pushes (costs money)
  full-evals:
    name: Full Agent Evals
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: smoke-test
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install anthropic pyyaml

      - name: Run core rules tests
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          if [ -z "$ANTHROPIC_API_KEY" ]; then
            echo "::warning::ANTHROPIC_API_KEY not set, skipping full evals"
            exit 0
          fi
          python tests/agents/run-evals.py --category core_rules

      - name: Run subagent tests
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        if: success()
        run: python tests/agents/run-evals.py --category subagents

  # Summary job
  eval-summary:
    name: Eval Summary
    runs-on: ubuntu-latest
    needs: [smoke-test, full-evals]
    if: always()
    steps:
      - name: Check results
        run: |
          if [ "${{ needs.smoke-test.result }}" == "failure" ]; then
            echo "::error::Smoke test failed"
            exit 1
          fi
          if [ "${{ needs.full-evals.result }}" == "failure" ]; then
            echo "::warning::Full evals failed (non-blocking)"
          fi
          echo "Agent evals completed"
