#!/usr/bin/env bash

set -Eeuo pipefail

readonly EARLYOOM_CONFIG_PATH="/etc/default/earlyoom"
readonly ZRAMSWAP_CONFIG_PATH="/etc/default/zramswap"
readonly EARLYOOM_SIGTERM_MEMORY_PERCENT=10
readonly EARLYOOM_SIGTERM_SWAP_PERCENT=15
readonly EARLYOOM_SIGKILL_MEMORY_PERCENT=5
readonly EARLYOOM_SIGKILL_SWAP_PERCENT=5
readonly ZRAM_COMPRESSION_ALGORITHM="zstd"
readonly ZRAM_MEMORY_PERCENT=50
readonly ZRAM_PRIORITY=100
readonly SWAPPINESS_VALUE=150

main() {
  echo "=== OOM & Freeze Protection Setup ==="
  echo ""

  _update_package_lists
  _install_and_configure_earlyoom
  _install_and_configure_zram
  _set_swappiness

  echo ""
  echo "=== Done ==="
  echo "Protections active:"
  echo "  - earlyoom: SIGTERM at ${EARLYOOM_SIGTERM_MEMORY_PERCENT}% free mem, SIGKILL at ${EARLYOOM_SIGKILL_MEMORY_PERCENT}%"
  echo "  - zram: ${ZRAM_COMPRESSION_ALGORITHM} compressed swap using ${ZRAM_MEMORY_PERCENT}% of RAM"
  echo "  - swappiness=${SWAPPINESS_VALUE}: aggressively uses zram before OOM"
  echo ""
  echo "Verify with:"
  echo "  systemctl status earlyoom"
  echo "  zramctl"
  echo "  sysctl vm.swappiness"
}

_update_package_lists() {
  echo "[1/4] Updating package lists..."
  sudo apt-get update -qq
}

_install_and_configure_earlyoom() {
  echo "[2/4] Installing and configuring earlyoom..."
  sudo apt-get install -y -qq earlyoom

  sudo tee "$EARLYOOM_CONFIG_PATH" > /dev/null <<CONF
EARLYOOM_ARGS="-m ${EARLYOOM_SIGTERM_MEMORY_PERCENT} -s ${EARLYOOM_SIGTERM_SWAP_PERCENT} -M ${EARLYOOM_SIGKILL_MEMORY_PERCENT} -S ${EARLYOOM_SIGKILL_SWAP_PERCENT} -r 3600 --avoid '(^|/)(init|Xorg|Xwayland|sshd|systemd)\$' --prefer '(^|/)(nix|nix-build|cc1plus|rustc|node|java|chrome_crashpad|claude)\$' -n"
CONF

  _activate_service earlyoom
}

_install_and_configure_zram() {
  echo "[3/4] Configuring zram..."
  sudo apt-get install -y -qq zram-tools

  sudo tee "$ZRAMSWAP_CONFIG_PATH" > /dev/null <<CONF
ALGO=${ZRAM_COMPRESSION_ALGORITHM}
PERCENT=${ZRAM_MEMORY_PERCENT}
PRIORITY=${ZRAM_PRIORITY}
CONF

  _activate_service zramswap
}

_set_swappiness() {
  echo "[4/4] Setting vm.swappiness to ${SWAPPINESS_VALUE}..."
  _apply_sysctl vm.swappiness "$SWAPPINESS_VALUE"
}

_activate_service() {
  local service_name="$1"
  if command -v systemctl &>/dev/null; then
    sudo systemctl enable --now "$service_name"
    echo "  $service_name active: $(systemctl is-active "$service_name")"
  else
    echo "  systemctl not found, $service_name will activate on next boot"
  fi
}

_apply_sysctl() {
  local key="$1" value="$2"
  echo "$key=$value" | sudo tee "/etc/sysctl.d/99-${key##*.}.conf" > /dev/null
  if sudo sysctl -w "$key=$value" 2>/dev/null; then
    echo "  $key=$value (applied live)"
  else
    echo "  $key=$value (will apply on next boot)"
  fi
}

main "$@"
