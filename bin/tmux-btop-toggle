#!/usr/bin/env bash
# Toggle btop pane in current tmux window
# Creates a maximized btop pane on demand, destroys it on exit

[ "${DEBUG:-}" = "1" ] && set -x
set -eu

CURRENT_WINDOW_ID=$(tmux display-message -p '#{window_id}')
CURRENT_PANE_ID=$(tmux display-message -p '#{pane_id}')
CURRENT_PANE_PATH=$(tmux display-message -p '#{pane_current_path}')

BTOP_PANE_ID=$(
    tmux list-panes -t "$CURRENT_WINDOW_ID" -F '#{pane_id} #{pane_title}' 2>/dev/null | \
        { grep -E '^%[0-9]+ btop$' || true; } | \
        cut -d' ' -f1 | \
        head -n1
)

if [ -n "${BTOP_PANE_ID:-}" ]; then
    tmux select-pane -t "$BTOP_PANE_ID"
    tmux resize-pane -Z
    exit 0
fi

PREV_PANE_ID="$CURRENT_PANE_ID"
PREV_PANE_ZOOMED=$(tmux display-message -p -t "$PREV_PANE_ID" '#{pane_zoomed}')

if ! NEW_PANE_ID=$(tmux split-window -v -c "$CURRENT_PANE_PATH" -P -F '#{pane_id}' 2>&1); then
    tmux display-message -d 3000 "Error: Failed to create pane: $NEW_PANE_ID"
    exit 1
fi

tmux select-pane -t "$NEW_PANE_ID" -T "btop" 2>/dev/null || exit 1
tmux resize-pane -Z -t "$NEW_PANE_ID" 2>/dev/null || exit 1

if [ "$PREV_PANE_ZOOMED" = "1" ]; then
    CLEANUP_SCRIPT="btop; tmux kill-pane -t $NEW_PANE_ID 2>/dev/null; tmux select-pane -t $PREV_PANE_ID 2>/dev/null; tmux resize-pane -Z -t $PREV_PANE_ID 2>/dev/null || true"
else
    CLEANUP_SCRIPT="btop; tmux kill-pane -t $NEW_PANE_ID 2>/dev/null; tmux select-pane -t $PREV_PANE_ID 2>/dev/null || true"
fi

tmux send-keys -t "$NEW_PANE_ID" "$CLEANUP_SCRIPT" Enter 2>/dev/null || exit 1

