#!/usr/bin/env bash
set -Eeuo pipefail

main() {
  if _all_tiled_windows_are_in_single_group; then
    _dissolve_active_group
  else
    _group_all_tiled_windows_on_active_workspace_and_maximize
  fi
}

_all_tiled_windows_are_in_single_group() {
  local ws
  ws=$(hyprctl activeworkspace -j | jq -r '.id')
  hyprctl clients -j | jq -e --argjson ws "$ws" '
    [.[] | select(.workspace.id == $ws and .floating == false)] |
    length as $total |
    $total > 0 and (map(.grouped | length) | max) == $total
  ' >/dev/null 2>&1
}

_dissolve_active_group() {
  hyprctl dispatch togglegroup
}

_get_tiled_window_addresses_on_active_workspace() {
  local ws
  ws=$(hyprctl activeworkspace -j | jq -r '.id')
  hyprctl clients -j | jq -r --argjson ws "$ws" \
    '.[] | select(.workspace.id == $ws and .floating == false) | .address'
}

_get_window_grouped_count() {
  hyprctl clients -j | jq --arg addr "$1" \
    '[.[] | select(.address == $addr)] | .[0].grouped | length'
}

_group_all_tiled_windows_on_active_workspace_and_maximize() {
  local addrs=()
  while IFS= read -r addr; do
    [[ -z "$addr" ]] && continue
    addrs+=("$addr")
  done < <(_get_tiled_window_addresses_on_active_workspace)

  [[ ${#addrs[@]} -eq 0 ]] && return

  if [[ ${#addrs[@]} -eq 1 ]]; then
    hyprctl --batch "dispatch focuswindow address:${addrs[0]}; dispatch fullscreen 1"
    return
  fi

  _suppress_cursor_warps
  trap _restore_cursor_warps EXIT

  _ensure_first_window_has_target_group "${addrs[0]}"

  for ((i = 1; i < ${#addrs[@]}; i++)); do
    _dissolve_and_move_into_target_group "${addrs[$i]}"
    sleep 0.15
  done

  _retry_ungrouped_windows "${addrs[@]}"

  hyprctl dispatch fullscreen 1

  _restore_cursor_warps
  trap - EXIT
}

_retry_ungrouped_windows() {
  local all_addrs=("$@")
  local expected=${#all_addrs[@]}

  local max_grouped
  max_grouped=$(_get_window_grouped_count "${all_addrs[0]}")
  [[ "$max_grouped" -ge "$expected" ]] && return

  sleep 0.3
  for addr in "${all_addrs[@]}"; do
    local gc
    gc=$(_get_window_grouped_count "$addr")
    if [[ "$gc" -lt "$expected" && "$gc" -le 1 ]]; then
      _dissolve_and_move_into_target_group "$addr"
      sleep 0.15
    fi
  done
}

_ensure_first_window_has_target_group() {
  local addr=$1
  local grouped_count
  grouped_count=$(_get_window_grouped_count "$addr")

  if [[ "$grouped_count" -eq 0 ]]; then
    hyprctl --batch "dispatch focuswindow address:$addr; dispatch togglegroup; dispatch lockactivegroup unlock"
  elif [[ "$grouped_count" -eq 1 ]]; then
    hyprctl --batch "dispatch focuswindow address:$addr; dispatch lockactivegroup unlock"
  else
    hyprctl --batch "dispatch focuswindow address:$addr; dispatch moveoutofgroup; dispatch togglegroup; dispatch lockactivegroup unlock"
  fi
}

_dissolve_and_move_into_target_group() {
  local addr=$1
  local grouped_count
  grouped_count=$(_get_window_grouped_count "$addr")

  if [[ "$grouped_count" -eq 1 ]]; then
    hyprctl --batch "dispatch focuswindow address:$addr; dispatch togglegroup; dispatch moveintogroup l; dispatch moveintogroup r; dispatch moveintogroup u; dispatch moveintogroup d"
  elif [[ "$grouped_count" -eq 0 ]]; then
    hyprctl --batch "dispatch focuswindow address:$addr; dispatch moveintogroup l; dispatch moveintogroup r; dispatch moveintogroup u; dispatch moveintogroup d"
  else
    hyprctl --batch "dispatch focuswindow address:$addr; dispatch moveoutofgroup; dispatch moveintogroup l; dispatch moveintogroup r; dispatch moveintogroup u; dispatch moveintogroup d"
  fi
}

_suppress_cursor_warps() {
  hyprctl keyword cursor:no_warps true >/dev/null 2>&1
}

_restore_cursor_warps() {
  hyprctl keyword cursor:no_warps false >/dev/null 2>&1
}

main
