#!/usr/bin/env bash

SOCKET="$XDG_RUNTIME_DIR/hypr/$HYPRLAND_INSTANCE_SIGNATURE/.socket2.sock"

get_active_fullscreen() {
  hyprctl activewindow -j 2>/dev/null | jq -r '.fullscreen // 0'
}

get_workspace_hasfullscreen() {
  local ws_id="$1"
  hyprctl workspaces -j 2>/dev/null | jq -r --arg ws "$ws_id" '.[] | select(.id == ($ws | tonumber)) | .hasfullscreen'
}

get_active_workspace() {
  hyprctl activewindow -j 2>/dev/null | jq -r '.workspace.id // empty'
}

maximized_workspaces=()

is_workspace_tracked() {
  local ws="$1"
  for tracked in "${maximized_workspaces[@]}"; do
    [[ "$tracked" == "$ws" ]] && return 0
  done
  return 1
}

add_workspace() {
  local ws="$1"
  if ! is_workspace_tracked "$ws"; then
    maximized_workspaces+=("$ws")
  fi
}

remove_workspace() {
  local ws="$1"
  local new_array=()
  for tracked in "${maximized_workspaces[@]}"; do
    [[ "$tracked" != "$ws" ]] && new_array+=("$tracked")
  done
  maximized_workspaces=("${new_array[@]}")
}

previous_focused_addr=""
current_focused_addr=""

handle_event() {
  local event="$1"
  local data="$2"

  case "$event" in
    activewindowv2)
      local new_addr="0x$data"
      if [[ "$new_addr" != "$current_focused_addr" ]]; then
        previous_focused_addr="$current_focused_addr"
        current_focused_addr="$new_addr"
      fi
      ;;
    fullscreen)
      if [[ "$data" == "1" ]]; then
        local ws
        ws=$(get_active_workspace)
        [[ -n "$ws" ]] && add_workspace "$ws"
      fi
      ;;
    closewindow)
      local closed_addr="0x$data"
      if [[ "$closed_addr" == "$current_focused_addr" && -n "$previous_focused_addr" ]]; then
        hyprctl dispatch focuswindow "address:$previous_focused_addr"
        current_focused_addr="$previous_focused_addr"
        previous_focused_addr=""
      elif [[ "$closed_addr" == "$previous_focused_addr" ]]; then
        previous_focused_addr=""
      fi
      sleep 0.03
      local ws
      ws=$(get_active_workspace)
      if [[ -n "$ws" ]] && is_workspace_tracked "$ws"; then
        local current_fullscreen
        current_fullscreen=$(get_active_fullscreen)
        if [[ "$current_fullscreen" != "1" ]]; then
          local window_count
          window_count=$(hyprctl clients -j 2>/dev/null | jq --arg ws "$ws" '[.[] | select(.workspace.id == ($ws | tonumber))] | length')
          if [[ "$window_count" -gt 0 ]]; then
            hyprctl dispatch fullscreen 1
          else
            remove_workspace "$ws"
          fi
        fi
      fi
      ;;
  esac
}

while IFS= read -r ws_id; do
  if [[ "$(get_workspace_hasfullscreen "$ws_id")" == "true" ]]; then
    add_workspace "$ws_id"
  fi
done < <(hyprctl workspaces -j | jq -r '.[].id')

current_focused_addr=$(hyprctl activewindow -j 2>/dev/null | jq -r '.address // empty')

while IFS= read -r line; do
  event="${line%%>>*}"
  data="${line#*>>}"
  handle_event "$event" "$data"
done < <(nc -U "$SOCKET")
