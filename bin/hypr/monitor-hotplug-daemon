#!/usr/bin/env bash
set -Eeuo pipefail

readonly SOCKET="$XDG_RUNTIME_DIR/hypr/$HYPRLAND_INSTANCE_SIGNATURE/.socket2.sock"
readonly OVERRIDE_FILE="${HOME}/.cache/hypr-monitors-override.conf"

_write_override_and_reload() {
  echo "$1" > "$OVERRIDE_FILE"
  hyprctl reload >/dev/null 2>&1
}

_restart_bar_and_shell() {
  sleep 1
  systemctl --user restart waybar.service 2>/dev/null || true
  systemctl --user restart hyprshell.service 2>/dev/null || true
}

handle_event() {
  local event="$1"
  local monitor_name="$2"

  case "$event" in
    monitorremoved)
      [[ "$monitor_name" == eDP* ]] && return
      _write_override_and_reload "monitor = eDP-1, preferred, auto, 1"
      _restart_bar_and_shell &
      ;;
    monitoradded)
      [[ "$monitor_name" == eDP* ]] && return
      _write_override_and_reload ""
      _restart_bar_and_shell &
      ;;
  esac
}

while IFS= read -r line; do
  event="${line%%>>*}"
  data="${line#*>>}"
  handle_event "$event" "$data"
done < <(nc -U "$SOCKET")
