#!/usr/bin/env bash
set -Eeuo pipefail

readonly NOTIFICATION_SOUNDS_MUTE_FLAG="$HOME/.cache/notification-sounds-muted"
readonly NOTIFICATION_SOUND_DAEMON_PID_FILE="$HOME/.cache/notification-sound-daemon.pid"
readonly NOTIFICATION_SOUND_FILE="/usr/share/sounds/freedesktop/stereo/message-new-instant.oga"

is_notification_sounds_muted() {
  [[ -f "$NOTIFICATION_SOUNDS_MUTE_FLAG" ]]
}

is_notification_sound_daemon_running() {
  [[ -f "$NOTIFICATION_SOUND_DAEMON_PID_FILE" ]] && kill -0 "$(cat "$NOTIFICATION_SOUND_DAEMON_PID_FILE")" 2>/dev/null
}

start_notification_sound_daemon() {
  stop_notification_sound_daemon

  local muteFlagPath="$NOTIFICATION_SOUNDS_MUTE_FLAG"
  local soundFile="$NOTIFICATION_SOUND_FILE"
  bash -c '
    trap "exit 0" TERM HUP
    dbus-monitor --session --monitor "interface='"'"'org.freedesktop.Notifications'"'"',member='"'"'Notify'"'"',type='"'"'method_call'"'"'" 2>/dev/null | while read -r dbusLine; do
      if [[ "$dbusLine" == *"member=Notify"* ]] && [[ ! -f "'"$muteFlagPath"'" ]]; then
        paplay "'"$soundFile"'" 2>/dev/null &
      fi
    done
  ' &
  echo $! > "$NOTIFICATION_SOUND_DAEMON_PID_FILE"
  disown
}

stop_notification_sound_daemon() {
  if [[ -f "$NOTIFICATION_SOUND_DAEMON_PID_FILE" ]]; then
    local daemonPid
    daemonPid=$(cat "$NOTIFICATION_SOUND_DAEMON_PID_FILE")
    pkill -P "$daemonPid" 2>/dev/null || true
    kill "$daemonPid" 2>/dev/null || true
    rm -f "$NOTIFICATION_SOUND_DAEMON_PID_FILE"
  fi
}

ensure_notification_sound_daemon_running() {
  if ! is_notification_sound_daemon_running; then
    start_notification_sound_daemon
  fi
}

toggle_notification_sounds() {
  if is_notification_sounds_muted; then
    rm -f "$NOTIFICATION_SOUNDS_MUTE_FLAG"
  else
    touch "$NOTIFICATION_SOUNDS_MUTE_FLAG"
  fi
}

notification_sound_status() {
  ensure_notification_sound_daemon_running
  if is_notification_sounds_muted; then
    echo '{"text":"󰂛","tooltip":"Notification sounds: OFF","class":"muted"}'
  else
    echo '{"text":"󰂚","tooltip":"Notification sounds: ON","class":"on"}'
  fi
}

case "${1:-status}" in
  toggle) toggle_notification_sounds ;;
  status) notification_sound_status ;;
  *) echo "Usage: $0 {toggle|status}" >&2; exit 1 ;;
esac
