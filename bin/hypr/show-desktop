#!/usr/bin/env bash
set -Eeuo pipefail

readonly STATE_DIR="${XDG_RUNTIME_DIR:-/tmp}/hyprland-show-desktop"
mkdir -p "$STATE_DIR"

main() {
  local current_ws
  current_ws=$(hyprctl monitors -j | jq -r '.[] | select(.focused) | .activeWorkspace.id')

  local state_file="$STATE_DIR/ws-$current_ws"
  local focus_file="$STATE_DIR/focus-$current_ws"

  if [[ -f "$state_file" ]]; then
    _restore_hidden_windows_and_maximize "$current_ws" "$state_file" "$focus_file"
  else
    _hide_all_workspace_windows_to_special_desktop "$current_ws" "$state_file" "$focus_file"
  fi
}

_hide_all_workspace_windows_to_special_desktop() {
  local ws=$1 state_file=$2 focus_file=$3

  local active_window
  active_window=$(hyprctl activewindow -j | jq -r '.address')

  local windows
  windows=$(hyprctl clients -j | jq -r --argjson ws "$ws" '.[] | select(.workspace.id == $ws) | .address')
  [[ -z "$windows" ]] && return

  [[ "$active_window" != "null" ]] && echo "$active_window" > "$focus_file"
  echo "$windows" > "$state_file"

  _dissolve_groups_on_workspace "$ws"

  local hide_batch=""
  while IFS= read -r addr; do
    hide_batch+="dispatch movetoworkspacesilent special:desktop,address:$addr; "
  done <<< "$windows"
  hyprctl --batch "${hide_batch%; }"
}

_dissolve_groups_on_workspace() {
  local ws=$1
  local grouped_window
  grouped_window=$(hyprctl clients -j | jq -r --argjson ws "$ws" '
    [.[] | select(.workspace.id == $ws and .floating == false and (.grouped | length) > 1)] | .[0].address // empty
  ')
  if [[ -n "$grouped_window" ]]; then
    hyprctl --batch "dispatch focuswindow address:$grouped_window; dispatch togglegroup"
  fi
}

_restore_hidden_windows_and_maximize() {
  local ws=$1 state_file=$2 focus_file=$3

  local move_batch=""
  while IFS= read -r addr; do
    move_batch+="dispatch movetoworkspacesilent $ws,address:$addr; "
  done < "$state_file"
  hyprctl --batch "${move_batch%; }"

  sleep 0.5

  if [[ -f "$focus_file" ]]; then
    hyprctl dispatch focuswindow "address:$(cat "$focus_file")"
    rm -f "$focus_file"
  fi

  rm -f "$state_file"

  _regroup_workspace_windows
}

_regroup_workspace_windows() {
  local ws
  ws=$(hyprctl activeworkspace -j | jq -r '.id')
  local all_grouped
  all_grouped=$(hyprctl clients -j | jq -e --argjson ws "$ws" '
    [.[] | select(.workspace.id == $ws and .floating == false)] |
    length as $total |
    $total > 0 and (map(.grouped | length) | max) == $total
  ' 2>/dev/null && echo true || echo false)

  if [[ "$all_grouped" != "true" ]]; then
    hypr-toggle-group-for-all-workspace-windows
  fi
}

main
