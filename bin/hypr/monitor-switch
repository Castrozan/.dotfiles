#!/usr/bin/env bash
# Daemon that switches between external and built-in monitors
# When external monitor is connected: disable built-in
# When external monitor is disconnected: enable built-in

CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/hypr-theme"
CONFIG="$CONFIG_DIR/monitor-switch.conf"

# Defaults (can be overridden by config file)
EXTERNAL="HDMI-A-1"
INTERNAL="eDP-1"
INTERNAL_MODE="preferred"

# Create config with defaults if it doesn't exist
if [[ ! -f "$CONFIG" ]]; then
  mkdir -p "$CONFIG_DIR"
  cat > "$CONFIG" << 'CONF'
# Monitor switch daemon configuration
# Edit this file to match your machine's monitors

# External monitor name (check with: hyprctl monitors all)
EXTERNAL="HDMI-A-1"

# Internal/built-in monitor name
INTERNAL="eDP-1"

# Mode for internal monitor when external is disconnected
# Format: WIDTHxHEIGHT@REFRESH (e.g., 1920x1080@120) or "preferred"
INTERNAL_MODE="preferred"
CONF
fi

# Source config
source "$CONFIG"

SOCKET="$XDG_RUNTIME_DIR/hypr/$HYPRLAND_INSTANCE_SIGNATURE/.socket2.sock"

is_monitor_connected() {
  hyprctl monitors -j | jq -e --arg name "$1" '.[] | select(.name == $name)' >/dev/null 2>&1
}

is_monitor_disabled() {
  hyprctl monitors all -j | jq -e --arg name "$1" '.[] | select(.name == $name and .disabled == true)' >/dev/null 2>&1
}

apply_config() {
  if is_monitor_connected "$EXTERNAL"; then
    # Only disable internal if it's not already disabled
    if ! is_monitor_disabled "$INTERNAL"; then
      hyprctl keyword monitor "$INTERNAL,disable"
    fi
  else
    # Only enable internal if it's currently disabled
    if is_monitor_disabled "$INTERNAL"; then
      hyprctl keyword monitor "$INTERNAL,$INTERNAL_MODE,auto,1"
    fi
  fi
}

# Apply initial configuration
apply_config

# Listen for monitor events
while IFS= read -r line; do
  event="${line%%>>*}"
  case "$event" in
    monitoradded|monitorremoved)
      sleep 0.2
      apply_config
      ;;
  esac
done < <(nc -U "$SOCKET")
