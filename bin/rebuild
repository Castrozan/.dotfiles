#!/usr/bin/env bash
# This script is used to rebuild the system using the dotfiles flake.

# Ensure nix is in PATH (needed for non-NixOS systems)
if ! command -v nix &>/dev/null; then
    if [ -f /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ]; then
        . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
    fi
fi

. /etc/os-release

if [ "$ID" = "nixos" ]; then
    # Set allowUnfree for unfree packages
    # Use sudo env to preserve only NIXPKGS_ALLOW_UNFREE, not HOME
    # This avoids the warning about HOME not being owned by root
    DOTFILES_PATH="$HOME/.dotfiles"
    USERNAME="$(whoami)"
    # Note: Pure evaluation - tested on home-manager only, NixOS testing pending
    sudo env "NIXPKGS_ALLOW_UNFREE=1" nixos-rebuild switch --flake "$DOTFILES_PATH#$USERNAME"

    # Post-rebuild: reload running environment
    # 1. Reload Hyprland config (keybinds, window rules, env vars, etc.)
    if command -v hyprctl &>/dev/null && hyprctl monitors &>/dev/null 2>&1; then
        echo ":: Reloading Hyprland..."
        hyprctl reload

        # 2. Restart graphical user services (waybar, swaync, etc.)
        echo ":: Restarting graphical services..."
        systemctl --user daemon-reload
        systemctl --user restart waybar.service swaync.service swayosd.service 2>/dev/null || true

        # 3. Re-apply theme colors
        if command -v omarchy-restart-hyprctl &>/dev/null; then
            omarchy-restart-hyprctl
        fi

        echo ":: Environment fully refreshed."
    fi
else
    # Standalone home-manager for non-NixOS systems
    # Detect architecture and build config name dynamically
    USERNAME="$(whoami)"
    ARCH="$(uname -m)"
    case "$ARCH" in
        x86_64) SYSTEM="x86_64-linux" ;;
        aarch64) SYSTEM="aarch64-linux" ;;
        *) SYSTEM="${ARCH}-linux" ;;
    esac
    CONFIG="${USERNAME}@${SYSTEM}"

    # Try methods in order of preference to avoid GitHub rate limits:

    # Method 1: Use home-manager directly if installed (best - no API calls)
    if command -v home-manager &>/dev/null; then
        home-manager switch --flake "$HOME/.dotfiles#$CONFIG" \
            -b "backup-$(date +%Y-%m-%d-%H-%M-%S)"
    # Method 2: Use nixpkgs#home-manager (good - uses cache, avoids GitHub API)
    elif nix run nixpkgs#home-manager -- --flake "$HOME/.dotfiles#$CONFIG" switch \
        -b "backup-$(date +%Y-%m-%d-%H-%M-%S)" 2>/dev/null; then
        : # Success
    else
        # Method 3: Fallback to GitHub (may hit rate limits - only if above methods fail)
        echo "Warning: Using GitHub source may hit rate limits. Consider installing home-manager:" >&2
        echo "  nix profile install nixpkgs#home-manager" >&2
        nix run home-manager/master -- --flake "$HOME/.dotfiles#$CONFIG" switch \
            -b "backup-$(date +%Y-%m-%d-%H-%M-%S)"
    fi
fi