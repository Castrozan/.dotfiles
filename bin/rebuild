#!/usr/bin/env bash

set -Eeuo pipefail

readonly DOTFILES_DIR="${HOME}/.dotfiles"
readonly BACKUP_PREFIX="backup"
readonly NIXOS_ALLOW_UNFREE="NIXPKGS_ALLOW_UNFREE=1"

main() {
  _rebuild_system
  _reload_hyprland || true
}

_rebuild_system() {
  echo ":: Rebuilding system configuration using dotfiles..."

  _ensure_nix_in_path_or_source_daemon_profile || {
    echo "Error: nix is not available in PATH and nix-daemon profile was not found." >&2
    return 1
  }

  _ensure_dotfiles_dir_exists || return 1
  _init_git_submodules_if_present "$DOTFILES_DIR" || true

  _source_os_release || return 1

  if _is_nixos; then
    _rebuild_nixos
  else
    _rebuild_home_manager
  fi
}

_ensure_nix_in_path_or_source_daemon_profile() {
  if command -v nix >/dev/null 2>&1; then
    return 0
  fi

  local daemon_profile="/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh"
  if [ -f "$daemon_profile" ]; then
    # shellcheck disable=SC1090
    . "$daemon_profile"
  fi

  command -v nix >/dev/null 2>&1
}

_ensure_dotfiles_dir_exists() {
  if [ ! -d "$DOTFILES_DIR" ]; then
    echo "Error: dotfiles directory not found at: $DOTFILES_DIR" >&2
    return 1
  fi
}

_init_git_submodules_if_present() {
  local dir=$1
  if [ -f "$dir/.gitmodules" ]; then
    git -C "$dir" submodule update --init --recursive 2>/dev/null || true
  fi
}

_source_os_release() {
  if [ ! -f /etc/os-release ]; then
    echo "Error: /etc/os-release not found. Cannot detect OS." >&2
    return 1
  fi

  # shellcheck disable=SC1091
  . /etc/os-release
}

_is_nixos() {
  [ "${ID:-}" = "nixos" ]
}

_rebuild_nixos() {
  local username dotfiles_path
  username="$(whoami)"
  dotfiles_path="$DOTFILES_DIR"

  echo ":: Detected NixOS. Running nixos-rebuild switch..."
  echo ":: Flake: ${dotfiles_path}#${username}"

  sudo env "$NIXOS_ALLOW_UNFREE" nixos-rebuild switch --flake "${dotfiles_path}#${username}"
}

_rebuild_home_manager() {
  local config
  config="$(_build_home_manager_config_name)"

  echo ":: Detected non-NixOS. Running home-manager switch..."
  echo ":: Flake: ${DOTFILES_DIR}#${config}"

  _hm_switch_with_rate_limit_fallback "$config"
}

_build_home_manager_config_name() {
  local username arch system
  username="$(whoami)"
  arch="$(uname -m)"

  case "$arch" in
    x86_64) system="x86_64-linux" ;;
    aarch64) system="aarch64-linux" ;;
    *) system="${arch}-linux" ;;
  esac

  echo "${username}@${system}"
}

_hm_switch_with_rate_limit_fallback() {
  local config=$1
  local backup
  backup="$(_backup_name)"

  if command -v home-manager >/dev/null 2>&1; then
    home-manager switch --flake "${DOTFILES_DIR}#${config}" -b "$backup"
    return 0
  fi

  if nix run nixpkgs#home-manager -- switch --flake "${DOTFILES_DIR}#${config}" -b "$backup" 2>/dev/null; then
    return 0
  fi

  echo "Warning: Falling back to GitHub source may hit rate limits." >&2
  echo "Tip: Install home-manager to avoid this:" >&2
  echo "  nix profile install nixpkgs#home-manager" >&2

  nix run home-manager/master -- switch --flake "${DOTFILES_DIR}#${config}" -b "$backup"
}

_backup_name() {
  printf '%s-%s\n' "$BACKUP_PREFIX" "$(date +%Y-%m-%d-%H-%M-%S)"
}

_reload_hyprland() {
  command -v hypr-restart-hyprctl >/dev/null 2>&1 || return 0
  echo ":: Reloading Hyprland..."
  hypr-restart-hyprctl
  echo ":: Environment fully refreshed."
}

main "$@"
