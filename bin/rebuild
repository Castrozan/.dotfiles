#!/usr/bin/env bash
# This script is used to rebuild the system using the dotfiles flake.

# Ensure nix is in PATH (needed for non-NixOS systems)
if ! command -v nix &>/dev/null; then
    if [ -f /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ]; then
        . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
    fi
fi

# Ensure submodules are initialized (private-config)
DOTFILES_DIR="${HOME}/.dotfiles"
if [ -f "$DOTFILES_DIR/.gitmodules" ]; then
    git -C "$DOTFILES_DIR" submodule update --init --recursive 2>/dev/null || true
fi

# Rebuild uses a git-based flake URL (`git+file://...`), which does NOT reliably
# include uncommitted changes. Warn early to avoid "why didn't my change apply?"
if git -C "$DOTFILES_DIR" rev-parse --is-inside-work-tree >/dev/null 2>&1; then
    if ! git -C "$DOTFILES_DIR" diff --quiet || ! git -C "$DOTFILES_DIR" diff --cached --quiet; then
        echo "Warning: $DOTFILES_DIR has uncommitted changes." >&2
        echo "  This rebuild uses git-based flake URLs; commit/stage changes if they must be included." >&2
        echo "  Run: git -C \"$DOTFILES_DIR\" status" >&2
    fi
fi

. /etc/os-release

if [ "$ID" = "nixos" ]; then
    # Set allowUnfree for unfree packages
    # Use sudo env to preserve only NIXPKGS_ALLOW_UNFREE, not HOME
    # This avoids the warning about HOME not being owned by root
    DOTFILES_PATH="$HOME/.dotfiles"
    USERNAME="$(whoami)"

    sudo env "NIXPKGS_ALLOW_UNFREE=1" nixos-rebuild switch --flake "git+file://$DOTFILES_PATH?submodules=1#$USERNAME" --impure

    # Post-rebuild: reload running environment
    # 1. Reload Hyprland config (keybinds, window rules, env vars, etc.)
    if command -v hyprctl &>/dev/null && hyprctl monitors &>/dev/null 2>&1; then
        echo ":: Reloading Hyprland..."
        hyprctl reload

        # 2. Restart graphical user services (waybar, mako, etc.)
        echo ":: Restarting graphical services..."
        systemctl --user daemon-reload
        systemctl --user restart waybar.service mako.service swayosd.service 2>/dev/null || true

        # 3. Re-apply theme colors
        if command -v omarchy-restart-hyprctl &>/dev/null; then
            omarchy-restart-hyprctl
        fi

        echo ":: Environment fully refreshed."
    fi
else
    # Standalone home-manager for non-NixOS systems
    # Detect architecture and build config name dynamically
    USERNAME="$(whoami)"
    ARCH="$(uname -m)"
    case "$ARCH" in
        x86_64) SYSTEM="x86_64-linux" ;;
        aarch64) SYSTEM="aarch64-linux" ;;
        *) SYSTEM="${ARCH}-linux" ;;
    esac
    CONFIG="${USERNAME}@${SYSTEM}"
    FLAKE="git+file://$HOME/.dotfiles?submodules=1#$CONFIG"

    # Try methods in order of preference to avoid GitHub rate limits:

    # Method 1: Use home-manager directly if installed (best - no API calls)
    if command -v home-manager &>/dev/null; then
        home-manager switch --flake "$FLAKE" \
            -b "backup-$(date +%Y-%m-%d-%H-%M-%S)"
    # Method 2: Use nixpkgs#home-manager (good - uses cache, avoids GitHub API)
    elif nix run nixpkgs#home-manager -- --flake "$FLAKE" switch \
        -b "backup-$(date +%Y-%m-%d-%H-%M-%S)" 2>/dev/null; then
        : # Success
    else
        # Method 3: Fallback to GitHub (may hit rate limits - only if above methods fail)
        echo "Warning: Using GitHub source may hit rate limits. Consider installing home-manager:" >&2
        echo "  nix profile install nixpkgs#home-manager" >&2
        nix run home-manager/master -- --flake "$FLAKE" switch \
            -b "backup-$(date +%Y-%m-%d-%H-%M-%S)"
    fi
fi
