#!/usr/bin/env bash

# Detect if we're on NixOS
if [ -f /etc/os-release ]; then
    . /etc/os-release
    if [ "$ID" = "nixos" ]; then
        # We're on NixOS
        # Set allowUnfree for nixGL and other unfree packages
        export NIXPKGS_ALLOW_UNFREE=1
        sudo -E nixos-rebuild switch --impure --flake $HOME/.dotfiles#"$(whoami)"
    else
        # Not nixos
        # Try methods in order of preference to avoid GitHub rate limits:

        # Method 1: Use home-manager directly if installed (best - no API calls)
        if command -v home-manager &>/dev/null; then
            home-manager switch --impure --flake "$HOME/.dotfiles#lucas.zanoni@x86_64-linux" \
                -b "backup-$(date +%Y-%m-%d-%H-%M-%S)"
        # Method 2: Use nixpkgs#home-manager (good - uses cache, avoids GitHub API)
        elif nix run nixpkgs#home-manager -- --impure --flake "$HOME/.dotfiles#lucas.zanoni@x86_64-linux" switch \
            -b "backup-$(date +%Y-%m-%d-%H-%M-%S)" 2>/dev/null; then
            : # Success
        # Method 3: Fallback to GitHub (may hit rate limits - only if above methods fail)
        else
            echo "Warning: Using GitHub source may hit rate limits. Consider installing home-manager:" >&2
            echo "  nix profile install nixpkgs#home-manager" >&2
            nix run home-manager/master -- --impure --flake "$HOME/.dotfiles#lucas.zanoni@x86_64-linux" switch \
                -b "backup-$(date +%Y-%m-%d-%H-%M-%S)"
        fi
    fi
fi 