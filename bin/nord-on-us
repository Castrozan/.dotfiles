#!/usr/bin/env bash
# Script to connect to NordVPN US server, handling Tailscale conflict
# Stops Tailscale, connects wgnord, then restarts Tailscale

# Check if running as root
if [ "$EUID" -ne 0 ]; then
    echo "This script must be run as root (with sudo)"
    exit 1
fi

# Check if Tailscale service is running
TAILSCALE_RUNNING=false
if systemctl is-active --quiet tailscaled 2>/dev/null; then
    TAILSCALE_RUNNING=true
    echo "Stopping Tailscale service..."
    systemctl stop tailscaled
    # Wait a moment for Tailscale to fully stop
    sleep 2
fi

# Connect to NordVPN US
echo "Connecting to NordVPN US server..."
if wgnord c US; then
    # Restart Tailscale if it was running before
    if [ "$TAILSCALE_RUNNING" = true ]; then
        echo "Restarting Tailscale service..."
        systemctl start tailscaled
        # Wait a moment for Tailscale to start
        sleep 2
        echo "Tailscale restarted"
    fi
    echo "NordVPN connected successfully!"
else
    # If wgnord failed, restart Tailscale anyway
    if [ "$TAILSCALE_RUNNING" = true ]; then
        echo "Failed to connect to NordVPN. Restarting Tailscale..."
        systemctl start tailscaled
        sleep 2
    fi
    exit 1
fi
