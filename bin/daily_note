#!/usr/bin/env bash
# daily_note.sh

# Constants
readonly MAX_DAYS_BACK=5
readonly TODO_SECTION_MARKER="## TODO"
readonly LAST_NOTES_HEADER="## Last Daily Notes with unchecked tasks"

# This script creates a daily note in the Obsidian vault.
# The note is named as Y-m-d-daily-note.md.
# When called multiple times in the same day, it opens the same note.
# Each note includes a header with the date and the note name.
# It also includes unchecked todos from the last N days (excluding today).
daily_note() {
    local filename fullpath today

    today=$(date "+%Y-%m-%d")
    filename=$(_get_daily_note_file_name "$today")

    if ! _validate_environment; then
        return 1
    fi

    fullpath="$OBSIDIAN_HOME/daily-note/$filename"

    # Create the file if it doesn't exist
    if [ ! -f "$fullpath" ]; then
        _create_new_note "$today" "$filename" "$fullpath"
    fi

    _open_daily_note "$fullpath"
}

# Validate the environment variables and requirements
_validate_environment() {
    if [ -z "$OBSIDIAN_HOME" ]; then
        echo "Error: OBSIDIAN_HOME is not defined."
        return 1
    fi
    return 0
}

# Generate the daily note file name
# Args:
#   $1: date (YYYY-MM-DD)
_get_daily_note_file_name() {
    local date=$1
    echo "$date-daily-note.md"
}

# Create a new note with headers and fetch unchecked todos
# Args:
#   $1: date (YYYY-MM-DD)
#   $2: filename
#   $3: fullpath
_create_new_note() {
    local date=$1 filename=$2 fullpath=$3

    {
        echo "# $date Daily Note"
        echo "### $filename"
        echo
        echo "$TODO_SECTION_MARKER"
        echo
        echo
        echo
        echo "$LAST_NOTES_HEADER"
    } >"$fullpath"

    _append_unchecked_todos "$fullpath"
}

# Get dates for the last N days, excluding today
# Args:
#   $1: number of days back
_get_past_dates() {
    local days=$1
    for i in $(seq 1 "$days"); do
        date -v "-${i}d" "+%Y-%m-%d" 2>/dev/null || date -d "-${i} days" "+%Y-%m-%d"
    done
}

# Check if a line contains an unchecked todo item
# Args:
#   $1: line to check
_is_unchecked_todo() {
    local line=$1
    # Match only lines that start with - [ ] (allowing for optional spaces)
    [[ "$line" =~ ^[[:space:]]*-[[:space:]]*\[[[:space:]]*\][[:space:]]+ ]]
}

# Check if a line contains a checked todo item
# Args:
#   $1: line to check
_is_checked_todo() {
    local line=$1
    # Match only lines that start with - [x] or - [X] (allowing for optional spaces)
    [[ "$line" =~ ^[[:space:]]*-[[:space:]]*\[[[:space:]]*[xX][[:space:]]*\][[:space:]]+ ]]
}

# Normalize todo content for comparisons (strip checkbox and surrounding spaces)
# Args:
#   $1: todo line
_normalize_todo_content() {
    local line=$1
    echo "$line" | sed -E 's/^[[:space:]]*-[[:space:]]*\[[[:space:]]*[xX ]?[[:space:]]*\][[:space:]]*//' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//'
}

# Extract only unchecked todo lines (no headers)
# Args:
#   $1: file path
_get_unchecked_todos() {
    local file=$1
    local in_todo_section=false

    while IFS= read -r line; do
        if [[ $line == "## TODO"* ]]; then
            in_todo_section=true
            continue
        fi

        # Leave TODO section when another header is reached
        if $in_todo_section && [[ $line == "## "* ]]; then
            break
        fi

        if $in_todo_section && _is_unchecked_todo "$line"; then
            echo "$line"
        fi
    done <"$file"
}

# Check if a todo content is marked checked in any later note (closer to today)
# Args:
#   $1: normalized todo content
#   $2: current index within past_dates array
#   $3...: past_dates array values
_is_todo_checked_in_later_notes() {
    local search_content=$1
    local current_index=$2
    shift 2
    local dates=("$@")

    # Earlier indices in dates[] are closer to today
    for ((i = 0; i < current_index; i++)); do
        local date=${dates[$i]}
        local filepath
        filepath="$OBSIDIAN_HOME/daily-note/$(_get_daily_note_file_name "$date")"
        [ -f "$filepath" ] || continue

        local in_todo_section=false
        while IFS= read -r line; do
            if [[ $line == "## TODO"* ]]; then
                in_todo_section=true
                continue
            fi

            if $in_todo_section && [[ $line == "## "* ]]; then
                break
            fi

            if $in_todo_section && _is_checked_todo "$line"; then
                if [[ $(_normalize_todo_content "$line") == "$search_content" ]]; then
                    return 0
                fi
            fi
        done <"$filepath"
    done

    return 1
}

# Extract unchecked todos from a file
# Args:
#   $1: file path
_extract_unchecked_todos() {
    local file=$1
    local filename todos

    filename=$(basename "$file")
    readarray -t todos < <(_get_unchecked_todos "$file")

    if [ ${#todos[@]} -gt 0 ]; then
        echo
        echo "### $filename"
        echo
        printf '%s\n' "${todos[@]}"
    fi
}

# Append unchecked todos from recent notes
# Args:
#   $1: current note path
_append_unchecked_todos() {
    local current_note=$1
    local past_dates

    readarray -t past_dates < <(_get_past_dates "$MAX_DAYS_BACK")

    for idx in "${!past_dates[@]}"; do
        local date=${past_dates[$idx]}
        local filename filepath todos filtered=()

        filename=$(_get_daily_note_file_name "$date")
        filepath="$OBSIDIAN_HOME/daily-note/$filename"
        [ -f "$filepath" ] || continue

        readarray -t todos < <(_get_unchecked_todos "$filepath")

        for todo_line in "${todos[@]}"; do
            local content
            content=$(_normalize_todo_content "$todo_line")
            if _is_todo_checked_in_later_notes "$content" "$idx" "${past_dates[@]}"; then
                continue
            fi
            filtered+=("$todo_line")
        done

        if [ ${#filtered[@]} -gt 0 ]; then
            {
                echo
                echo "### $filename"
                echo
                printf '%s\n' "${filtered[@]}"
            } >>"$current_note"
        fi
    done
}

# Open the daily note
# Args:
#   $1: file path
_open_daily_note() {
    local fullpath=$1

    if [[ "$EDITOR" == "code" || "$EDITOR" == "cursor" ]]; then
        # Check if the editor is VS Code
        # code "$OBSIDIAN_HOME" "-g" "$fullpath" will open the note
        "$EDITOR" "$OBSIDIAN_HOME" "-g" "$fullpath" >/dev/null 2>&1 & disown
    else
        # For other editors (vim, nvim, nano, etc.)
        "$EDITOR" "$fullpath" >/dev/null 2>&1 & disown
    fi
}

# Main execution
daily_note
