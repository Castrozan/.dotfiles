#!/usr/bin/env bash
set -euo pipefail

BRANCH="${1:?Usage: git-worktree-crypt <branch-name>}"
REPO_ROOT="$(git rev-parse --show-toplevel)"
WORKTREE_PATH="$REPO_ROOT/.worktrees/$BRANCH"
WORKTREE_NAME="$(basename "$WORKTREE_PATH")"

cd "$REPO_ROOT"

# Temporarily disable git-crypt filter during worktree creation
# (--no-checkout alone doesn't fully prevent filter invocation)
git -c filter.git-crypt.smudge=cat -c filter.git-crypt.clean=cat \
    worktree add --no-checkout -b "$BRANCH" "$WORKTREE_PATH" main

# Link git-crypt keys to worktree's git dir (enables smudge filter)
# Git uses basename of worktree path for .git/worktrees/<name>
WORKTREE_GIT_DIR="$REPO_ROOT/.git/worktrees/$WORKTREE_NAME"
rm -f "$WORKTREE_GIT_DIR/git-crypt" 2>/dev/null || true
ln -s "$REPO_ROOT/.git/git-crypt" "$WORKTREE_GIT_DIR/git-crypt"

# Checkout files (smudge filter now works via symlink)
cd "$WORKTREE_PATH"
git reset --hard HEAD

echo "Worktree ready at $WORKTREE_PATH"
