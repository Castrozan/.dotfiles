#!/usr/bin/env bash
# Initialize git-crypt in the dotfiles repo and add user's GPG key
# Usage: git-crypt-setup [GPG_KEY_ID]
# If no GPG key provided, will attempt to find one automatically

set -euo pipefail

DOTFILES_DIR="${HOME}/.dotfiles"

cd "${DOTFILES_DIR}" || {
    echo "Error: Could not change to ${DOTFILES_DIR}" >&2
    exit 1
}

# Check if git-crypt is available
if ! command -v git-crypt &>/dev/null; then
    echo "Error: git-crypt not found. Run 'rebuild' first to install it." >&2
    exit 1
fi

# Check if already initialized
if [ -d ".git-crypt" ]; then
    echo "git-crypt is already initialized in this repository."
    echo ""
    echo "To add another GPG key: git-crypt add-gpg-user <KEY_ID>"
    echo "To check status: git-crypt status"
    echo "To unlock on new machine: git-crypt unlock"
    exit 0
fi

# Get GPG key
GPG_KEY="${1:-}"
if [ -z "${GPG_KEY}" ]; then
    # Try to find a GPG key automatically
    GPG_KEY=$(gpg --list-secret-keys --keyid-format LONG 2>/dev/null | grep -E "^sec" | head -1 | awk '{print $2}' | cut -d'/' -f2)
    if [ -z "${GPG_KEY}" ]; then
        echo "Error: No GPG secret key found. Please provide a GPG key ID." >&2
        echo "Usage: git-crypt-setup <GPG_KEY_ID>" >&2
        exit 1
    fi
    echo "Found GPG key: ${GPG_KEY}"
fi

echo "Initializing git-crypt..."
git-crypt init

echo "Adding GPG key ${GPG_KEY}..."
git-crypt add-gpg-user "${GPG_KEY}"

echo ""
echo "git-crypt initialized successfully!"
echo ""
echo "Files matching patterns in .gitattributes will be encrypted."
echo "Current encryption patterns:"
grep -E "filter=git-crypt" .gitattributes 2>/dev/null || echo "  (none configured)"
echo ""
echo "Next steps:"
echo "  1. Add private files to private-config/claude/agents/ or private-config/claude/skills/"
echo "  2. Stage and commit the files: git add private-config/ && git commit"
echo "  3. Verify encryption: git-crypt status"
echo ""
echo "On a new machine:"
echo "  1. Clone the repo"
echo "  2. Run: git-crypt unlock"
