#!/usr/bin/env bash

set -Eeuo pipefail

readonly PINCHTAB_BASE_URL="http://localhost:9867"

main() {
	local field_specs_json="$1"

	_ensure_pinchtab_is_running

	local field_count
	field_count=$(python3 -c "import json,sys; print(len(json.loads(sys.argv[1])))" "$field_specs_json")

	local all_results="["
	local field_index=0

	while [[ $field_index -lt $field_count ]]; do
		local field_spec
		field_spec=$(python3 -c "import json,sys; print(json.dumps(json.loads(sys.argv[1])[$field_index]))" "$field_specs_json" "$field_index")

		local field_type
		field_type=$(python3 -c "import json,sys; print(json.loads(sys.argv[1]).get('type','text'))" "$field_spec")

		local result
		if [[ "$field_type" == "select" ]]; then
			result=$(_fill_ant_design_select_field "$field_spec")
		else
			result=$(_fill_react_text_field "$field_spec")
		fi

		if [[ $field_index -gt 0 ]]; then
			all_results+=","
		fi
		all_results+="$result"

		field_index=$((field_index + 1))
	done

	all_results+="]"
	echo "$all_results"
}

_ensure_pinchtab_is_running() {
	if ! curl -sf --max-time 2 "${PINCHTAB_BASE_URL}/health" >/dev/null 2>&1; then
		echo "Error: pinchtab is not running at ${PINCHTAB_BASE_URL}" >&2
		return 1
	fi
}

_fill_react_text_field() {
	local field_spec="$1"
	local javascript_expression
	javascript_expression=$(_build_text_field_fill_expression "$field_spec")

	curl -sf --max-time 10 -X POST "${PINCHTAB_BASE_URL}/evaluate" \
		-H "Content-Type: application/json" \
		-d "{\"expression\":${javascript_expression}}" 2>/dev/null | python3 -c "
import json, sys
response = json.load(sys.stdin)
print(response.get('result', json.dumps({'success': False, 'error': 'no result'})))
" 2>/dev/null || echo '{"success":false,"error":"evaluate failed"}'
}

_build_text_field_fill_expression() {
	local field_spec="$1"

	python3 -c "
import json, sys

spec = json.loads(sys.argv[1])
selector = spec['selector']
value = spec['value']

js_code = '''(function() {
  const selector = __SELECTOR__;
  const value = __VALUE__;
  const element = document.querySelector(selector);
  if (!element) return JSON.stringify({selector: selector, success: false, error: 'element not found'});

  element.focus();

  const nativeInputValueSetter = Object.getOwnPropertyDescriptor(
    window.HTMLInputElement.prototype, 'value'
  ) || Object.getOwnPropertyDescriptor(
    window.HTMLTextAreaElement.prototype, 'value'
  );

  if (nativeInputValueSetter && nativeInputValueSetter.set) {
    nativeInputValueSetter.set.call(element, value);
  } else {
    element.value = value;
  }

  element.dispatchEvent(new Event('input', { bubbles: true }));
  element.dispatchEvent(new Event('change', { bubbles: true }));

  return JSON.stringify({selector: selector, success: true, type: 'text'});
})()'''

js_code = js_code.replace('__SELECTOR__', json.dumps(selector))
js_code = js_code.replace('__VALUE__', json.dumps(value))
print(json.dumps(js_code))
" "$field_spec"
}

_fill_ant_design_select_field() {
	local field_spec="$1"
	local selector
	selector=$(python3 -c "import json,sys; print(json.loads(sys.argv[1])['selector'])" "$field_spec")
	local option_text
	option_text=$(python3 -c "import json,sys; print(json.loads(sys.argv[1])['value'])" "$field_spec")

	_open_ant_design_dropdown "$selector"
	sleep 0.4
	_click_ant_design_dropdown_option "$selector" "$option_text"
}

_open_ant_design_dropdown() {
	local selector="$1"
	local javascript_expression
	javascript_expression=$(python3 -c "
import json, sys
selector = sys.argv[1]
js_code = '''(function() {
  const container = document.querySelector(__SELECTOR__);
  if (!container) return JSON.stringify({success: false, error: 'selector not found'});
  const clickTarget = container.querySelector('.ant-select-selector') || container.querySelector('.ant-select-content') || container;
  clickTarget.dispatchEvent(new MouseEvent('mousedown', { bubbles: true }));
  return JSON.stringify({success: true, action: 'dropdown_opened'});
})()'''
js_code = js_code.replace('__SELECTOR__', json.dumps(selector))
print(json.dumps(js_code))
" "$selector")

	curl -sf --max-time 10 -X POST "${PINCHTAB_BASE_URL}/evaluate" \
		-H "Content-Type: application/json" \
		-d "{\"expression\":${javascript_expression}}" >/dev/null 2>&1
}

_click_ant_design_dropdown_option() {
	local selector="$1"
	local option_text="$2"
	local javascript_expression
	javascript_expression=$(python3 -c "
import json, sys
selector = sys.argv[1]
option_text = sys.argv[2]
js_code = '''(function() {
  const options = document.querySelectorAll('.ant-select-item-option-content');
  for (const option of options) {
    if (option.textContent.trim() === __OPTION_TEXT__) {
      option.closest('.ant-select-item').click();
      return JSON.stringify({selector: __SELECTOR__, success: true, type: 'select', value: __OPTION_TEXT__});
    }
  }
  return JSON.stringify({selector: __SELECTOR__, success: false, error: 'option not found: ' + __OPTION_TEXT__});
})()'''
js_code = js_code.replace('__SELECTOR__', json.dumps(selector))
js_code = js_code.replace('__OPTION_TEXT__', json.dumps(option_text))
print(json.dumps(js_code))
" "$selector" "$option_text")

	curl -sf --max-time 10 -X POST "${PINCHTAB_BASE_URL}/evaluate" \
		-H "Content-Type: application/json" \
		-d "{\"expression\":${javascript_expression}}" 2>/dev/null | python3 -c "
import json, sys
response = json.load(sys.stdin)
print(response.get('result', json.dumps({'success': False, 'error': 'no result'})))
" 2>/dev/null || echo "{\"selector\":\"$selector\",\"success\":false,\"error\":\"evaluate failed\"}"
}

main "$@"
