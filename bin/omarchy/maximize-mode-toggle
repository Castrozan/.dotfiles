#!/usr/bin/env bash
# Toggle maximize mode for current workspace
# Enter: track mode, maximize current window (don't move others yet - daemon handles swaps)
# Exit: bring all windows back from special workspaces

STATE_DIR="/tmp/hypr-maximize-mode"
mkdir -p "$STATE_DIR"

get_active_workspace() {
  hyprctl activeworkspace -j | jq -r '.id'
}

get_active_address() {
  hyprctl activewindow -j | jq -r '.address // empty'
}

get_workspace_windows() {
  local ws="$1"
  hyprctl clients -j | jq -r --arg ws "$ws" \
    '.[] | select(.workspace.id == ($ws | tonumber)) | .address'
}

enter_maximize_mode() {
  local ws="$1"
  local focused="$2"
  local state_file="$STATE_DIR/$ws"

  # Get all windows on this workspace
  local windows
  windows=$(get_workspace_windows "$ws")

  if [[ -z "$windows" ]]; then
    return 1
  fi

  # Count windows - need at least 2 for maximize mode to make sense
  local count
  count=$(echo "$windows" | wc -l)
  if [[ "$count" -lt 2 ]]; then
    # Single window - just toggle normal fullscreen
    hyprctl dispatch fullscreen 1
    return 0
  fi

  # Write state: first line is workspace, rest are window addresses
  # Format: ws_id on line 1, then all window addresses
  {
    echo "$ws"
    echo "$windows"
  } > "$state_file"

  # Also write current focused window to a separate file for daemon to track
  echo "$focused" > "$STATE_DIR/${ws}_current"

  # Maximize current window
  hyprctl dispatch fullscreen 1
}

exit_maximize_mode() {
  local ws="$1"
  local state_file="$STATE_DIR/$ws"

  if [[ ! -f "$state_file" ]]; then
    return 1
  fi

  # Un-maximize current window first
  local current
  current=$(get_active_address)
  if [[ -n "$current" ]]; then
    local fullscreen
    fullscreen=$(hyprctl activewindow -j | jq -r '.fullscreen // 0')
    if [[ "$fullscreen" == "1" ]]; then
      hyprctl dispatch fullscreen 1
    fi
  fi

  # Bring all windows back from special workspaces
  hyprctl clients -j | jq -r --arg ws "$ws" \
    '.[] | select(.workspace.name | startswith("special:max_\($ws)_")) | .address' | \
  while IFS= read -r addr; do
    if [[ -n "$addr" ]]; then
      hyprctl dispatch movetoworkspace "$ws,address:$addr"
    fi
  done

  rm -f "$state_file" "$STATE_DIR/${ws}_current"
}

is_maximize_mode() {
  local ws="$1"
  [[ -f "$STATE_DIR/$ws" ]]
}

# Main
ws=$(get_active_workspace)
focused=$(get_active_address)

if [[ -z "$ws" || -z "$focused" ]]; then
  exit 1
fi

if is_maximize_mode "$ws"; then
  exit_maximize_mode "$ws"
else
  enter_maximize_mode "$ws" "$focused"
fi
