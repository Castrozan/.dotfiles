#!/usr/bin/env bash
# Toggle maximize mode for current workspace
# Enter: move windows to special workspaces, switch to maximize submap
# Exit: bring windows back, switch to normal submap

STATE_DIR="/tmp/hypr-maximize-mode"
mkdir -p "$STATE_DIR"

get_active_workspace() {
  hyprctl activeworkspace -j | jq -r '.id'
}

get_active_address() {
  hyprctl activewindow -j | jq -r '.address // empty'
}

get_workspace_windows() {
  local ws="$1"
  hyprctl clients -j | jq -r --arg ws "$ws" \
    '.[] | select(.workspace.id == ($ws | tonumber)) | .address'
}

enter_maximize_mode() {
  local ws="$1"
  local focused="$2"
  local state_file="$STATE_DIR/$ws"

  local windows
  windows=$(get_workspace_windows "$ws")
  [[ -z "$windows" ]] && return 1

  local count
  count=$(echo "$windows" | wc -l)
  if [[ "$count" -lt 2 ]]; then
    hyprctl dispatch fullscreen 1
    return 0
  fi

  # Save state
  {
    echo "$ws"
    echo "$windows"
  } > "$state_file"
  echo "$focused" > "$STATE_DIR/${ws}_current"

  # Move all OTHER windows to special workspaces (focused stays for now)
  while IFS= read -r addr; do
    if [[ "$addr" != "$focused" && -n "$addr" ]]; then
      hyprctl dispatch movetoworkspacesilent "special:max_${ws}_${addr#0x},address:$addr"
    fi
  done <<< "$windows"

  # Now move focused to its special workspace and toggle it visible
  hyprctl dispatch movetoworkspacesilent "special:max_${ws}_${focused#0x},address:$focused"
  hyprctl dispatch togglespecialworkspace "max_${ws}_${focused#0x}"

  # Switch to maximize submap (uses our switcher instead of hyprshell)
  hyprctl dispatch submap maximize
}

exit_maximize_mode() {
  local ws="$1"
  local state_file="$STATE_DIR/$ws"
  [[ -f "$state_file" ]] || return 1

  local orig_ws
  orig_ws=$(head -1 "$state_file")

  # Switch back to normal submap first
  hyprctl dispatch submap reset

  # Bring all windows back from special workspaces
  hyprctl clients -j | jq -r --arg ws "$orig_ws" \
    '.[] | select(.workspace.name | startswith("special:max_\($ws)_")) | .address' | \
  while IFS= read -r addr; do
    [[ -n "$addr" ]] && hyprctl dispatch movetoworkspace "$orig_ws,address:$addr"
  done

  # Switch to original workspace
  hyprctl dispatch workspace "$orig_ws"

  rm -f "$state_file" "$STATE_DIR/${ws}_current"
}

is_maximize_mode() {
  [[ -f "$STATE_DIR/$1" ]]
}

# Main
ws=$(get_active_workspace)

# Handle being on a special workspace
if [[ "$ws" == special:max_* ]]; then
  orig_ws=$(echo "$ws" | sed 's/special:max_\([0-9]*\)_.*/\1/')
  exit_maximize_mode "$orig_ws"
  exit 0
fi

focused=$(get_active_address)
[[ -z "$ws" || -z "$focused" ]] && exit 1

if is_maximize_mode "$ws"; then
  exit_maximize_mode "$ws"
else
  enter_maximize_mode "$ws" "$focused"
fi
