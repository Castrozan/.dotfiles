#!/usr/bin/env bash
# Toggle maximize mode for current workspace
# Enter: track mode, maximize current window (daemon handles swaps on focus change)
# Exit: bring all windows back, un-maximize

STATE_DIR="/tmp/hypr-maximize-mode"
mkdir -p "$STATE_DIR"

get_active_workspace() {
  hyprctl activeworkspace -j | jq -r '.id'
}

get_active_address() {
  hyprctl activewindow -j | jq -r '.address // empty'
}

get_workspace_windows() {
  local ws="$1"
  hyprctl clients -j | jq -r --arg ws "$ws" \
    '.[] | select(.workspace.id == ($ws | tonumber)) | .address'
}

enter_maximize_mode() {
  local ws="$1"
  local focused="$2"
  local state_file="$STATE_DIR/$ws"

  local windows
  windows=$(get_workspace_windows "$ws")
  [[ -z "$windows" ]] && return 1

  local count
  count=$(echo "$windows" | wc -l)
  if [[ "$count" -lt 2 ]]; then
    hyprctl dispatch fullscreen 1
    return 0
  fi

  # Save state: workspace and all window addresses
  {
    echo "$ws"
    echo "$windows"
  } > "$state_file"

  # Track current focused window for daemon
  echo "$focused" > "$STATE_DIR/${ws}_current"

  # Maximize current window
  hyprctl dispatch fullscreen 1
}

exit_maximize_mode() {
  local ws="$1"
  local state_file="$STATE_DIR/$ws"
  [[ -f "$state_file" ]] || return 1

  # Read original workspace
  local orig_ws
  orig_ws=$(head -1 "$state_file")

  # Bring all windows back from special workspaces
  hyprctl clients -j | jq -r --arg ws "$orig_ws" \
    '.[] | select(.workspace.name | startswith("special:max_\($ws)_")) | .address' | \
  while IFS= read -r addr; do
    [[ -n "$addr" ]] && hyprctl dispatch movetoworkspace "$orig_ws,address:$addr"
  done

  # Un-maximize current window
  local fullscreen
  fullscreen=$(hyprctl activewindow -j | jq -r '.fullscreen // 0')
  [[ "$fullscreen" == "1" ]] && hyprctl dispatch fullscreen 1

  rm -f "$state_file" "$STATE_DIR/${ws}_current"
}

is_maximize_mode() {
  [[ -f "$STATE_DIR/$1" ]]
}

# Main
ws=$(get_active_workspace)

# Handle being on a special workspace
if [[ "$ws" == special:max_* ]]; then
  orig_ws=$(echo "$ws" | sed 's/special:max_\([0-9]*\)_.*/\1/')
  exit_maximize_mode "$orig_ws"
  exit 0
fi

focused=$(get_active_address)
[[ -z "$ws" || -z "$focused" ]] && exit 1

if is_maximize_mode "$ws"; then
  exit_maximize_mode "$ws"
else
  enter_maximize_mode "$ws" "$focused"
fi
