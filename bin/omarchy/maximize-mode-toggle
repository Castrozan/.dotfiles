#!/usr/bin/env bash
# Toggle maximize mode for current workspace
# Enter: move each window to its own special workspace (always maximized)
# Exit: bring all windows back to original workspace

STATE_DIR="/tmp/hypr-maximize-mode"
mkdir -p "$STATE_DIR"

get_active_workspace() {
  hyprctl activeworkspace -j | jq -r '.id'
}

get_active_address() {
  hyprctl activewindow -j | jq -r '.address // empty'
}

get_workspace_windows() {
  local ws="$1"
  hyprctl clients -j | jq -r --arg ws "$ws" \
    '.[] | select(.workspace.id == ($ws | tonumber)) | .address'
}

enter_maximize_mode() {
  local ws="$1"
  local focused="$2"
  local state_file="$STATE_DIR/$ws"

  local windows
  windows=$(get_workspace_windows "$ws")
  [[ -z "$windows" ]] && return 1

  local count
  count=$(echo "$windows" | wc -l)
  if [[ "$count" -lt 2 ]]; then
    hyprctl dispatch fullscreen 1
    return 0
  fi

  # Save original workspace and windows
  echo "$ws" > "$state_file"
  echo "$windows" >> "$state_file"

  # Move ALL windows (including focused) to their own special workspaces
  while IFS= read -r addr; do
    [[ -n "$addr" ]] && hyprctl dispatch movetoworkspacesilent "special:max_${ws}_${addr#0x},address:$addr"
  done <<< "$windows"

  # Switch to focused window's special workspace
  hyprctl dispatch togglespecialworkspace "max_${ws}_${focused#0x}"
}

exit_maximize_mode() {
  local ws="$1"
  local state_file="$STATE_DIR/$ws"
  [[ -f "$state_file" ]] || return 1

  # Read original workspace from first line
  local orig_ws
  orig_ws=$(head -1 "$state_file")

  # Bring all windows back from special workspaces
  hyprctl clients -j | jq -r --arg ws "$ws" \
    '.[] | select(.workspace.name | startswith("special:max_\($ws)_")) | .address' | \
  while IFS= read -r addr; do
    [[ -n "$addr" ]] && hyprctl dispatch movetoworkspace "$orig_ws,address:$addr"
  done

  # Switch back to original workspace
  hyprctl dispatch workspace "$orig_ws"

  rm -f "$state_file"
}

is_maximize_mode() {
  [[ -f "$STATE_DIR/$1" ]]
}

# Main
ws=$(get_active_workspace)

# Handle being on a special workspace (already in maximize mode)
if [[ "$ws" == special:max_* ]]; then
  # Extract original workspace from special workspace name
  orig_ws=$(echo "$ws" | sed 's/special:max_\([0-9]*\)_.*/\1/')
  exit_maximize_mode "$orig_ws"
  exit 0
fi

focused=$(get_active_address)
[[ -z "$ws" || -z "$focused" ]] && exit 1

if is_maximize_mode "$ws"; then
  exit_maximize_mode "$ws"
else
  enter_maximize_mode "$ws" "$focused"
fi
