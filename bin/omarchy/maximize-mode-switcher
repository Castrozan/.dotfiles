#!/usr/bin/env bash
# Switch between windows in maximize mode
# Each window is in its own special workspace - swap by toggling workspaces

STATE_DIR="/tmp/hypr-maximize-mode"

# Get current special workspace name
current_ws=$(hyprctl activeworkspace -j | jq -r '.name // empty')

# Must be on a special:max_* workspace
if [[ "$current_ws" != special:max_* ]]; then
  exit 0
fi

# Extract original workspace ID from special workspace name
orig_ws=$(echo "$current_ws" | sed 's/special:max_\([0-9]*\)_.*/\1/')

# Get current window address
current_addr=$(hyprctl activewindow -j | jq -r '.address // empty')

# Get all windows in maximize mode rotation for this workspace
readarray -t all_windows < <(hyprctl clients -j | jq -r --arg ws "$orig_ws" '
  [.[] | select(.workspace.name | startswith("special:max_\($ws)_"))] |
  sort_by(.focusHistoryID) | .[].address
')

# Need at least 2 windows to switch
[[ ${#all_windows[@]} -lt 2 ]] && exit 0

# Find current window index
current_idx=-1
for i in "${!all_windows[@]}"; do
  if [[ "${all_windows[$i]}" == "$current_addr" ]]; then
    current_idx=$i
    break
  fi
done

[[ $current_idx -lt 0 ]] && exit 0

# Get next window (circular)
next_idx=$(( (current_idx + 1) % ${#all_windows[@]} ))
next_addr="${all_windows[$next_idx]}"

# Get next window's special workspace name
next_ws=$(hyprctl clients -j | jq -r --arg addr "$next_addr" \
  '.[] | select(.address == $addr) | .workspace.name')

# Hide current special workspace, show next
# Extract the special workspace suffix (after special:)
current_suffix="${current_ws#special:}"
next_suffix="${next_ws#special:}"

hyprctl dispatch togglespecialworkspace "$current_suffix"
hyprctl dispatch togglespecialworkspace "$next_suffix"
