#!/usr/bin/env bash
# Launcher with maximize state handling: unmaximize window if maximized, launch fuzzel
# Super+Q toggles: if fuzzel running, close it and restore maximize state

# If fuzzel is already running, kill it and let original process handle restore
if pgrep -x fuzzel > /dev/null; then
    pkill -x fuzzel
    exit 0
fi

activewindow=$(hyprctl activewindow -j)
fullscreen=$(echo "$activewindow" | jq -r '.fullscreen')
address=$(echo "$activewindow" | jq -r '.address')

was_maximized=false
if [[ "$fullscreen" == "1" ]]; then
    was_maximized=true
    hyprctl dispatch fullscreen 1
fi

# Get window count before fuzzel
windows_before=$(hyprctl clients -j | jq 'length')

omarchy-fuzzel

# Small delay to let any launched app create its window
sleep 0.15

# Get window count after fuzzel
windows_after=$(hyprctl clients -j | jq 'length')

# If no new window was created and original was maximized, restore it
if [[ "$was_maximized" == "true" && "$windows_after" -le "$windows_before" ]]; then
    hyprctl dispatch focuswindow "address:$address"
    hyprctl dispatch fullscreen 1
fi
