#!/usr/bin/env bash
# GNOME-like super key behavior: unmaximize window if maximized, then launch fuzzel
# If fuzzel is cancelled (Esc/Super), restore maximize state
# Skips if Super+Tab window switcher (hyprshell) is active

# Check at release time: if hyprshell layer is visible, exit immediately
# This is more reliable than polling at start - by release time, switcher is definitely visible
if hyprctl layers -j | grep -q '"hyprshell"'; then
    exit 0
fi

activewindow=$(hyprctl activewindow -j)
fullscreen=$(echo "$activewindow" | jq -r '.fullscreen')
address=$(echo "$activewindow" | jq -r '.address')

was_maximized=false
if [[ "$fullscreen" == "1" ]]; then
    was_maximized=true
    hyprctl dispatch fullscreen 1
fi

# Get window count before fuzzel
windows_before=$(hyprctl clients -j | jq 'length')

omarchy-fuzzel

# Small delay to let any launched app create its window
sleep 0.15

# Get window count after fuzzel
windows_after=$(hyprctl clients -j | jq 'length')

# If no new window was created and original was maximized, restore it
if [[ "$was_maximized" == "true" && "$windows_after" -le "$windows_before" ]]; then
    hyprctl dispatch focuswindow "address:$address"
    hyprctl dispatch fullscreen 1
fi
