#!/usr/bin/env bash

menu() {
  local prompt="$1"
  local options="$2"
  local lines="${3:-5}"

  echo -e "$options" | omarchy-fuzzel --dmenu --width 30 --lines "$lines" --prompt "$prompt> " 2>/dev/null
}

get_power_status() {
  bluetoothctl show 2>/dev/null | grep -q "Powered: yes" && echo "on" || echo "off"
}

get_paired_devices() {
  bluetoothctl paired-devices 2>/dev/null | sed 's/\x1b\[[0-9;]*m//g; s/Device //' | grep -E '^[0-9A-Fa-f]{2}:' | awk '!seen[$1]++'
}

is_device_connected() {
  local mac="$1"
  bluetoothctl info "$mac" 2>/dev/null | grep -q "Connected: yes"
}

get_bt_card() {
  local mac="$1"
  echo "bluez_card.${mac//:/_}"
}

get_active_profile() {
  local card
  card=$(get_bt_card "$1")
  pactl list cards 2>/dev/null | awk -v card="$card" '
    $0 ~ "Name: " card { found=1 }
    found && /Active Profile:/ { print $NF; exit }
  '
}

toggle_profile() {
  local mac="$1" name="$2"
  local card profile_label
  card=$(get_bt_card "$mac")
  local active
  active=$(get_active_profile "$mac")

  if [[ "$active" == "a2dp_sink" ]]; then
    pactl set-card-profile "$card" handsfree_head_unit
    profile_label="HFP (mic enabled)"
  else
    pactl set-card-profile "$card" a2dp_sink
    profile_label="A2DP (high quality)"
  fi

  notify-send -t 2000 "Bluetooth" "$name → $profile_label"
}

get_connected_devices() {
  local devices connected=""
  devices=$(bluetoothctl paired-devices 2>/dev/null | sed 's/\x1b\[[0-9;]*m//g; s/Device //' | grep -E '^[0-9A-Fa-f]{2}:' | awk '!seen[$1]++')
  while IFS= read -r line; do
    [[ -z "$line" ]] && continue
    local mac
    mac=$(echo "$line" | awk '{print $1}')
    if is_device_connected "$mac"; then
      connected+="$line\n"
    fi
  done <<<"$devices"
  echo -e "${connected%\\n}"
}

toggle_power() {
  if [[ "$(get_power_status)" == "on" ]]; then
    bluetoothctl power off
    notify-send -t 2000 "Bluetooth" "Powered off"
  else
    bluetoothctl power on
    notify-send -t 2000 "Bluetooth" "Powered on"
  fi
}

scan_devices() {
  notify-send -t 3000 "Bluetooth" "Scanning for devices..."
  bluetoothctl --timeout 5 scan on &>/dev/null &

  sleep 5

  local devices
  devices=$(bluetoothctl devices 2>/dev/null | sed 's/\x1b\[[0-9;]*m//g; s/Device //' | grep -E '^[0-9A-Fa-f]{2}:' | awk '!seen[$1]++')

  if [[ -z "$devices" ]]; then
    notify-send -t 2000 "Bluetooth" "No devices found"
    show_main_menu
    return
  fi

  local selection
  selection=$(menu "Found Devices" "$devices" 8)

  if [[ -n "$selection" ]]; then
    local mac name
    mac=$(echo "$selection" | awk '{print $1}')
    name=$(echo "$selection" | cut -d' ' -f2-)

    case $(menu "Pair $name" "󰂱  Pair & Connect\n  Cancel" 2) in
      *Pair*)
        notify-send -t 2000 "Bluetooth" "Pairing with $name..."
        bluetoothctl pair "$mac" 2>/dev/null
        sleep 1
        if bluetoothctl connect "$mac" 2>/dev/null; then
          notify-send -t 2000 "Bluetooth" "Connected to $name"
        else
          notify-send -t 2000 "Bluetooth" "Failed to connect to $name"
        fi
        ;;
    esac
  fi

  show_main_menu
}

show_paired_devices() {
  local devices
  devices=$(get_paired_devices)

  if [[ -z "$devices" ]]; then
    notify-send -t 2000 "Bluetooth" "No paired devices"
    show_main_menu
    return
  fi

  local formatted=""
  while IFS= read -r line; do
    local mac name
    mac=$(echo "$line" | awk '{print $1}')
    name=$(echo "$line" | cut -d' ' -f2-)
    if is_device_connected "$mac"; then
      formatted+="󰂱  $name ($mac)\n"
    else
      formatted+="󰂲  $name ($mac)\n"
    fi
  done <<<"$devices"
  formatted="${formatted%\\n}"

  local selection
  selection=$(menu "Paired Devices" "$formatted" 6)

  if [[ -n "$selection" ]]; then
    local mac
    mac=$(echo "$selection" | grep -oEi '([0-9A-F]{2}:){5}[0-9A-F]{2}')
    local name
    name=$(echo "$selection" | sed 's/^[^ ]* *//' | sed "s/ ($mac)//")

    if is_device_connected "$mac"; then
      local active_profile profile_toggle
      active_profile=$(get_active_profile "$mac")
      if [[ "$active_profile" == "a2dp_sink" ]]; then
        profile_toggle="󰍬  Switch to HFP (mic)"
      else
        profile_toggle="󰎈  Switch to A2DP (quality)"
      fi

      case $(menu "$name" "$profile_toggle\n󰂲  Disconnect\n  Remove\n  Cancel" 4) in
        *Switch*)
          toggle_profile "$mac" "$name"
          ;;
        *Disconnect*)
          if bluetoothctl disconnect "$mac" 2>/dev/null; then
            notify-send -t 2000 "Bluetooth" "Disconnected from $name"
          else
            notify-send -t 2000 "Bluetooth" "Failed to disconnect"
          fi
          ;;
        *Remove*)
          bluetoothctl disconnect "$mac" 2>/dev/null
          if bluetoothctl remove "$mac" 2>/dev/null; then
            notify-send -t 2000 "Bluetooth" "Removed $name"
          else
            notify-send -t 2000 "Bluetooth" "Failed to remove $name"
          fi
          ;;
      esac
    else
      case $(menu "$name" "󰂱  Connect\n  Remove\n  Cancel" 3) in
        *Connect*)
          notify-send -t 2000 "Bluetooth" "Connecting to $name..."
          if bluetoothctl connect "$mac" 2>/dev/null; then
            notify-send -t 2000 "Bluetooth" "Connected to $name"
          else
            notify-send -t 2000 "Bluetooth" "Failed to connect"
          fi
          ;;
        *Remove*)
          if bluetoothctl remove "$mac" 2>/dev/null; then
            notify-send -t 2000 "Bluetooth" "Removed $name"
          else
            notify-send -t 2000 "Bluetooth" "Failed to remove $name"
          fi
          ;;
      esac
    fi
  fi

  show_main_menu
}

show_main_menu() {
  local power_status power_icon power_text
  power_status=$(get_power_status)

  if [[ "$power_status" == "on" ]]; then
    power_icon="󰂯"
    power_text="Power Off"
  else
    power_icon="󰂲"
    power_text="Power On"
  fi

  local connected
  connected=$(get_connected_devices | grep -c .)
  local connected_text=""
  if [[ "$connected" -gt 0 ]]; then
    connected_text=" ($connected connected)"
  fi

  local options="󰂱  Paired Devices$connected_text\n󰂰  Scan for Devices\n$power_icon  $power_text\n󰒓  Open Settings"

  case $(menu "Bluetooth" "$options" 4) in
    *Paired*) show_paired_devices ;;
    *Scan*) scan_devices ;;
    *Power*) toggle_power; show_main_menu ;;
    *Settings*) blueman-manager & ;;
  esac
}

if [[ "$1" == "--full" ]]; then
  blueman-manager &
else
  show_main_menu
fi
