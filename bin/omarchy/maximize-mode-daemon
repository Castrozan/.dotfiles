#!/usr/bin/env bash
# Daemon that handles maximize mode window swaps
# When focus changes in maximize mode, moves previous window to special workspace

STATE_DIR="/tmp/hypr-maximize-mode"
SOCKET="$XDG_RUNTIME_DIR/hypr/$HYPRLAND_INSTANCE_SIGNATURE/.socket2.sock"

mkdir -p "$STATE_DIR"

is_maximize_mode() {
  [[ -f "$STATE_DIR/$1" ]]
}

get_current_tracked() {
  local ws="$1"
  [[ -f "$STATE_DIR/${ws}_current" ]] && cat "$STATE_DIR/${ws}_current"
}

handle_activewindow() {
  local ws
  ws=$(hyprctl activeworkspace -j | jq -r '.id')

  # Not in maximize mode? Exit
  is_maximize_mode "$ws" || return

  local new_addr
  new_addr=$(hyprctl activewindow -j | jq -r '.address // empty')
  [[ -z "$new_addr" ]] && return

  local prev_addr
  prev_addr=$(get_current_tracked "$ws")

  # Same window? Nothing to do
  [[ "$new_addr" == "$prev_addr" ]] && return

  # Move previous window to special workspace
  if [[ -n "$prev_addr" ]]; then
    local prev_exists
    prev_exists=$(hyprctl clients -j | jq -r --arg addr "$prev_addr" \
      '.[] | select(.address == $addr) | .workspace.name // empty')

    # Only move if still on main workspace (not already in special)
    if [[ -n "$prev_exists" && "$prev_exists" != special:max_* ]]; then
      hyprctl dispatch movetoworkspacesilent "special:max_${ws}_${prev_addr#0x},address:$prev_addr"
    fi
  fi

  # Update tracked window
  echo "$new_addr" > "$STATE_DIR/${ws}_current"

  # Maximize new window (now alone on workspace)
  local fullscreen
  fullscreen=$(hyprctl activewindow -j | jq -r '.fullscreen // 0')
  [[ "$fullscreen" != "1" ]] && hyprctl dispatch fullscreen 1
}

handle_closewindow() {
  local addr="0x$1"
  # Remove closed window from state files
  for f in "$STATE_DIR"/*; do
    [[ -f "$f" && "$f" != *_current ]] && sed -i "/^${addr}$/d" "$f" 2>/dev/null
  done
}

# Event loop
while IFS= read -r line; do
  event="${line%%>>*}"
  data="${line#*>>}"

  case "$event" in
    activewindow) handle_activewindow ;;
    closewindow) handle_closewindow "$data" ;;
  esac
done < <(nc -U "$SOCKET")
