#!/usr/bin/env bash

set -Eeuo pipefail

readonly VOLUME_ICONS_DIR="$HOME/.config/scripts/icons"
readonly VOLUME_STEP_NORMAL=5
readonly VOLUME_STEP_PRECISE=1

main() {
	case "${1:-}" in
	--inc) _increase_volume "$VOLUME_STEP_NORMAL" ;;
	--dec) _decrease_volume "$VOLUME_STEP_NORMAL" ;;
	--inc-precise) _increase_volume "$VOLUME_STEP_PRECISE" ;;
	--dec-precise) _decrease_volume "$VOLUME_STEP_PRECISE" ;;
	--toggle) _toggle_mute ;;
	--toggle-mic) _toggle_microphone_mute ;;
	--mic-inc) _increase_microphone_volume "$VOLUME_STEP_NORMAL" ;;
	--mic-dec) _decrease_microphone_volume "$VOLUME_STEP_NORMAL" ;;
	--get) _get_volume_for_active_sink ;;
	--get-icon) _get_volume_icon_for_active_sink ;;
	--get-mic-icon) echo "$VOLUME_ICONS_DIR/microphone.png" ;;
	*) _get_volume_for_active_sink ;;
	esac
}

_find_active_sink_name_or_default() {
	local running_hardware_sink
	running_hardware_sink=$(pactl list sinks short | awk '$7 == "RUNNING" && $2 !~ /^echo-cancel/ { print $2; exit }')
	if [[ -n "$running_hardware_sink" ]]; then
		echo "$running_hardware_sink"
	else
		echo "@DEFAULT_SINK@"
	fi
}

_get_volume_for_active_sink() {
	local sink_name
	sink_name=$(_find_active_sink_name_or_default)
	pactl get-sink-volume "$sink_name" | grep -oP '\d+%' | head -1 | tr -d '%'
}

_is_sink_muted() {
	local sink_name
	sink_name=$(_find_active_sink_name_or_default)
	pactl get-sink-mute "$sink_name" | grep -q "yes"
}

_get_volume_icon_for_active_sink() {
	local current_volume
	current_volume=$(_get_volume_for_active_sink)

	if _is_sink_muted || [[ "$current_volume" -eq 0 ]]; then
		echo "$VOLUME_ICONS_DIR/volume-mute.png"
	elif [[ "$current_volume" -le 30 ]]; then
		echo "$VOLUME_ICONS_DIR/volume-low.png"
	elif [[ "$current_volume" -le 60 ]]; then
		echo "$VOLUME_ICONS_DIR/volume-mid.png"
	else
		echo "$VOLUME_ICONS_DIR/volume-high.png"
	fi
}

_increase_volume() {
	local step=$1
	local sink_name
	sink_name=$(_find_active_sink_name_or_default)
	pactl set-sink-volume "$sink_name" "+${step}%"
	_send_volume_osd
}

_decrease_volume() {
	local step=$1
	local sink_name
	sink_name=$(_find_active_sink_name_or_default)
	pactl set-sink-volume "$sink_name" "-${step}%"
	_send_volume_osd
}

_toggle_mute() {
	local sink_name
	sink_name=$(_find_active_sink_name_or_default)
	pactl set-sink-mute "$sink_name" toggle

	if _is_sink_muted; then
		quickshell-osd-send mute true
	else
		_send_volume_osd
	fi
}

_send_volume_osd() {
	local current_volume
	current_volume=$(_get_volume_for_active_sink)
	quickshell-osd-send volume "$current_volume"
}

_increase_microphone_volume() {
	local step=$1
	pactl set-source-volume @DEFAULT_SOURCE@ "+${step}%"
	_send_microphone_osd
}

_decrease_microphone_volume() {
	local step=$1
	pactl set-source-volume @DEFAULT_SOURCE@ "-${step}%"
	_send_microphone_osd
}

_toggle_microphone_mute() {
	pactl set-source-mute @DEFAULT_SOURCE@ toggle

	if pactl get-source-mute @DEFAULT_SOURCE@ | grep -q "yes"; then
		quickshell-osd-send mic-mute true
	else
		_send_microphone_osd
	fi
}

_send_microphone_osd() {
	local current_volume
	current_volume=$(pactl get-source-volume @DEFAULT_SOURCE@ | grep -oP '\d+%' | head -1 | tr -d '%')
	quickshell-osd-send mic "$current_volume"
}

main "$@"
