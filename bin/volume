#!/usr/bin/env bash

set -Eeuo pipefail

readonly VOLUME_ICONS_DIR="$HOME/.config/scripts/icons"
readonly VOLUME_STEP_NORMAL=5
readonly VOLUME_STEP_PRECISE=1
readonly NOTIFICATION_TIMEOUT=1000
readonly NOTIFICATION_TAG="volume"
readonly NOTIFICATION_TAG_MIC="microphone"

main() {
	case "${1:-}" in
	--inc) _increase_volume "$VOLUME_STEP_NORMAL" ;;
	--dec) _decrease_volume "$VOLUME_STEP_NORMAL" ;;
	--inc-precise) _increase_volume "$VOLUME_STEP_PRECISE" ;;
	--dec-precise) _decrease_volume "$VOLUME_STEP_PRECISE" ;;
	--toggle) _toggle_mute ;;
	--toggle-mic) _toggle_microphone_mute ;;
	--mic-inc) _increase_microphone_volume "$VOLUME_STEP_NORMAL" ;;
	--mic-dec) _decrease_microphone_volume "$VOLUME_STEP_NORMAL" ;;
	--get) _get_volume_for_active_sink ;;
	--get-icon) _get_volume_icon_for_active_sink ;;
	--get-mic-icon) echo "$VOLUME_ICONS_DIR/microphone.png" ;;
	*) _get_volume_for_active_sink ;;
	esac
}

_find_active_sink_name_or_default() {
	local running_sink
	running_sink=$(pactl list sinks short | awk '$7 == "RUNNING" { print $2; exit }')
	if [[ -n "$running_sink" ]]; then
		echo "$running_sink"
	else
		echo "@DEFAULT_SINK@"
	fi
}

_get_volume_for_active_sink() {
	local sink_name
	sink_name=$(_find_active_sink_name_or_default)
	pactl get-sink-volume "$sink_name" | grep -oP '\d+%' | head -1 | tr -d '%'
}

_is_sink_muted() {
	local sink_name
	sink_name=$(_find_active_sink_name_or_default)
	pactl get-sink-mute "$sink_name" | grep -q "yes"
}

_get_volume_icon_for_active_sink() {
	local current_volume
	current_volume=$(_get_volume_for_active_sink)

	if _is_sink_muted || [[ "$current_volume" -eq 0 ]]; then
		echo "$VOLUME_ICONS_DIR/volume-mute.png"
	elif [[ "$current_volume" -le 30 ]]; then
		echo "$VOLUME_ICONS_DIR/volume-low.png"
	elif [[ "$current_volume" -le 60 ]]; then
		echo "$VOLUME_ICONS_DIR/volume-mid.png"
	else
		echo "$VOLUME_ICONS_DIR/volume-high.png"
	fi
}

_increase_volume() {
	local step=$1
	local sink_name
	sink_name=$(_find_active_sink_name_or_default)
	pactl set-sink-volume "$sink_name" "+${step}%"
	_send_volume_notification
}

_decrease_volume() {
	local step=$1
	local sink_name
	sink_name=$(_find_active_sink_name_or_default)
	pactl set-sink-volume "$sink_name" "-${step}%"
	_send_volume_notification
}

_toggle_mute() {
	local sink_name
	sink_name=$(_find_active_sink_name_or_default)
	pactl set-sink-mute "$sink_name" toggle

	if _is_sink_muted; then
		_send_notification "$NOTIFICATION_TAG" "$VOLUME_ICONS_DIR/volume-mute.png" "Volume Muted" 0
	else
		_send_volume_notification
	fi
}

_send_volume_notification() {
	local current_volume icon
	current_volume=$(_get_volume_for_active_sink)
	icon=$(_get_volume_icon_for_active_sink)
	_send_notification "$NOTIFICATION_TAG" "$icon" "Volume: ${current_volume}%" "$current_volume"
}

_increase_microphone_volume() {
	local step=$1
	pactl set-source-volume @DEFAULT_SOURCE@ "+${step}%"
	_send_microphone_notification
}

_decrease_microphone_volume() {
	local step=$1
	pactl set-source-volume @DEFAULT_SOURCE@ "-${step}%"
	_send_microphone_notification
}

_toggle_microphone_mute() {
	pactl set-source-mute @DEFAULT_SOURCE@ toggle

	if pactl get-source-mute @DEFAULT_SOURCE@ | grep -q "yes"; then
		_send_notification "$NOTIFICATION_TAG_MIC" "microphone-sensitivity-muted-symbolic" "Microphone Muted" 0
	else
		_send_microphone_notification
	fi
}

_send_microphone_notification() {
	local current_volume
	current_volume=$(pactl get-source-volume @DEFAULT_SOURCE@ | grep -oP '\d+%' | head -1 | tr -d '%')
	_send_notification "$NOTIFICATION_TAG_MIC" "microphone-sensitivity-high-symbolic" "Microphone: ${current_volume}%" "$current_volume"
}

_send_notification() {
	local tag=$1 icon=$2 message=$3 value=$4
	notify-send \
		-t "$NOTIFICATION_TIMEOUT" \
		-h "int:value:${value}" \
		-h "string:x-canonical-private-synchronous:${tag}" \
		-u low \
		-i "$icon" \
		"$message"
}

main "$@"
